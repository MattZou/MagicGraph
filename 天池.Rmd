---
title: "Magic Graph 魔图"
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
    source_code: embed
    theme: flatly
    #sandstone
    # logo: logo.png
    # favicon: favicon.png
---

```{r setup, include=FALSE}
library(flexdashboard)
library(leaflet)
library(plotly)
library(maptools)
library(ggplot2)
library(dplyr)
library(plyr)
library(reshape2)
library(xts)
library(pairsD3)

sites = read.csv('station.csv');
aq = read.csv('空气质量关系.csv')
me = read.csv('南京天气.csv')

winddir <- function(x){
   temp = as.character((x - 11.25) %/% 22.5 +2)
   dir = switch (temp,
           "1" = "N" ,
           "2" = "NNE",
           "3" = "NE",
           "4" = "ENE",
           "5" = "E",
           "6" = "ESE",
           "7" = "SE",
           "8" = "SSE",
           "9" = "S",
           "10" = "SSW",
           "11" = "SW",
           "12" = "WSW",
           "13" = "W",
           "14" = "WNW",
           "15" = "NW",
           "16" = "NNW",
           "17" = "N"
           )
   return(dir)
}

windspeed <- function(x){
  temp = as.character(x %/% 2)
  speed = switch (temp,
                "0" = "0~1 m/s" ,
                "1" = "2~3 m/s",
                "2" = "4~5 m/s",
                "3" = "6~7 m/s",
                "4" = "8~9 m/s",
                "5" = "10 m/s"              
  )
  return(speed)
}


```


Air Quality {data-icon="fa-list"}
=======================================================================

Row
-----------------------------------------------------------------------

### 站点地图

```{r}
leaflet() %>% 
  addTiles() %>% 
  fitBounds(118.815,31.851,118.685,32.311) %>% 
  
  addCircleMarkers(sites$x, 
                   sites$y, 
                   color = sites$color, 
                   radius = 8, 
                   fill = T,
                   fillOpacity = 0.2,
                   opacity = 0.6,
                   popup = paste( sites$name,"<b>AQI</b>",
                                  sites$aqi,
                                  sep = "<br/>")) %>%

  addLegend("bottomleft", 
            colors = c("green","yellow","orange","red","mediumvioletred","maroon"),
            labels = c("优",
                       "良",
                       "轻度污染",
                       "中度污染",
                       "重度污染",
                       "严重污染"), 
            opacity = 0.7)

  
```

### 站点污染级别天数比例

```{r}
#Ggplot2
# aq1 = subset(aq,select = c("站点","污染级别"))
# a = as.data.frame(table(aq1))
# a = ddply(a, "站点", transform, 比例 = Freq/sum(Freq)*100)
# a = subset(a,select = c("站点","污染级别","比例"))
# p <- ggplot(a,aes(x = 站点 , weight = 比例, fill = 污染级别))+ geom_bar(position="stack")+ scale_fill_brewer(palette = "Set3") + ylab("百分比") + ggtitle(" ") 
# 
# ggplotly(p)

aq1 = subset(aq,select = c("站点","污染级别"))
a = as.data.frame(table(aq1))
a = ddply(a, "站点", transform, percent_weight = Freq/sum(Freq)*100)
a <- subset(a,select = c("站点","污染级别","percent_weight"))
a <- dcast(a,站点~污染级别, value.var="percent_weight")

p <- plot_ly(
  x = a$站点,
  y = round(a$良,2),
  name = "良",
  type = "bar",marker = list(color = toRGB("yellow"))) 
p <- add_trace(
  p,
  x = a$站点,
  y = round(a$轻度污染,2),
  name = "轻度污染",
  type = "bar",marker = list(color = toRGB("orange")))
p <- add_trace(
  p,
  x = a$站点,
  y = round(a$中度污染,2),
  name = "中度污染",
  type = "bar",marker = list(color = toRGB("red")))
p <- add_trace(
  p,
  x = a$站点,
  y = round(a$重度污染,2),
  name = "重度污染",
  type = "bar",marker = list(color = toRGB("mediumvioletred")))
p <- add_trace(
  p,
  x = a$站点,
  y = round(a$严重污染,2),
  name = "严重污染",
  type = "bar",marker = list(color = toRGB("maroon")))

x <- list(
  title = " ",
  showgrid = T,
  showline = TRUE
)
y <- list(
  title = "百分比",
    showgrid = T,
    showline = TRUE
)
p <- layout(p, barmode = "stack",xaxis = x, yaxis = y )
p
```

Row {.tabset .tabset-fade}
-----------------------------------------------------------------------
```{r}
#make plot sava as p
pollution_curve = function(pollution,xtitle,ytitle){ 
  poll = aq %>% 
  subset(select = c('站点','time',pollution)) %>% 
  dcast(time~站点, value.var=pollution)
  poll$time = as.POSIXct(as.character(poll$time),'%Y%m%d%H',tz='UTC')
  rownames(poll) = poll[,1]
  poll = as.xts(poll)
  ds = data.frame(Date = index(poll), poll[,2], poll[,3], poll[,4], poll[,5], poll[,6], poll[,7],poll[,8],poll[,9],poll[,10])  
  p =plot_ly(ds, x = Date, y = 奥体中心, mode = "lines", name = "奥体中心")%>%
    add_trace(x = Date, y = 草场门, name = "草场门") %>% 
    add_trace(x = Date, y = 迈皋桥, name = "迈皋桥") %>% 
    add_trace(x = Date, y = 浦口, name = "浦口") %>% 
    add_trace(x = Date, y = 瑞金路, name = "瑞金路") %>% 
    add_trace(x = Date, y = 山西路, name = "山西路") %>%
    add_trace(x = Date, y = 仙林大学城, name = "仙林大学城") %>% 
    add_trace(x = Date, y = 玄武湖, name = "玄武湖") %>% 
    add_trace(x = Date, y = 中华门, name = "中华门") %>% 
  layout(
    title = "站点污染物监测数据",
    yaxis = list(title = ytitle),
    xaxis = list(
      title = xtitle,
      rangeselector = list(
        buttons = list(
          list(
            count = 8, 
            label = "8 小时", 
            step = "hour",
            stepmode = "backward"),
          list(
            count = 1, 
            label = "1 天", 
            step = "day",
            stepmode = "backward"),
          list(
            count = 7, 
            label = "1 周", 
            step = "day",
            stepmode = "backward"),
          list(
            count = 1, 
            label = "1 月", 
            step = "month",
            stepmode = "backward"),
          list(
            label = "全部", 
            step = "all")
          )
        )
      )
    )
  return(p)
}

#draw all the picture at once
pollution = c('AQI','SO2','NO2','CO','O3','PM10','PM2.5')
xtitle = rep("时间", 7)
ytitle = c("AQI","浓度 μg/m3", "浓度 μg/m3", "浓度 mg/m3", "浓度 μg/m3", "浓度 μg/m3", "浓度 μg/m3")
# # a list to save all the pictures  
# pic = list()
# for (i in 1:7){
#   poll = aq %>% 
#     subset(select = c('站点','time',pollution[i])) %>% 
#     dcast(time~站点, value.var=pollution[i])
#   pic[[i]] = pollution_curve(poll, xtitle[i], ytitle[i])
# }

```

### AQI
```{r}
pollution_curve(pollution[1], xtitle[1], ytitle[1])
```

### SO2
```{r}
pollution_curve(pollution[2], xtitle[2], ytitle[2])
```

### NO2
```{r}
pollution_curve(pollution[3], xtitle[3], ytitle[3])
```

### CO
```{r}
pollution_curve(pollution[4], xtitle[4], ytitle[4])
```

### O3
```{r}
pollution_curve(pollution[5], xtitle[5], ytitle[5])
```

### PM10
```{r}
pollution_curve(pollution[6], xtitle[6], ytitle[6])
```

### PM2.5
```{r}
pollution_curve(pollution[7], xtitle[7], ytitle[7])
```


Meteorologic {data-icon="fa-list" data-orientation=columns}
=======================================================================

Column 
-------------------------------------
    
### 12月全国风场图 {.no-padding}
![风场格点实况数据由中国气象局公开发布的国家级2170个地面气象站的观测数据反演而成](全国风场图.gif)


Column {data-width=300}
-------------------------------------
   
### 南京站风玫瑰图 {.no-padding data-height=650}

```{r}
meteoro = me[,3:9] %>% 
  filter(温度... != 999999 & 相对湿度!= 999999 & 降水量.mm.!= 999999 & 风向!= 999999 & 风力.m.s.!= 999999)
meteoro = split(meteoro,meteoro$县)
a = meteoro[[1]]
a = a[,6:7]
#unlist 列表转向量
a  = mutate(a,t = unlist(lapply(a$风向,winddir)), ws = unlist(lapply(a$风力.m.s.,windspeed)))
a = a[,3:4]
a = as.data.frame(table(a))
a = ddply(a, "t", transform, percent_weight = Freq/sum(Freq)*100)
a$ws = a$ws[order(a[,2], decreasing=TRUE)]
a$t = factor(c("N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"), ordered=TRUE)
p = plot_ly(a, r = Freq, t = t, color = ws, type = "area") %>%
layout(radialaxis = list(ticksuffix = "%"), orientation = 270,width = 600, height = 510, opacity = 0.8)
p

```   

 
### 南京站降雨量分布
    
```{r}

```


b 
=======================================================================


Row {data-height=500}
-------------------------------------

### Chart 1

```{r}
aq_relat = subset(aq, select=c(站点,SO2,NO2,CO,O3,PM10,PM2.5,AQI))
pairsD3(aq_relat[,6:8], group = aq_relat[,1],big = TRUE,width = 500, tooltip = aq_relat[,1],leftmar = 100,opacity = 0.6)
```

### Chart 2

```{r}
```

Row
-------------------------------------

### Chart 3

```{r}
```

### Chart 4

```{r}
```